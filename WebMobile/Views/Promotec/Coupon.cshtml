@{
    ViewBag.Title = "";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script id="config_couponPage_tmpl" type="text/x-jquery-tmpl">
    <div style="height:${couponPage.bgHeight01}px">
        <img src="${couponPage.bg01}" style="height:100%" />
    </div>
    <div style="position: relative;height:${couponPage.bgHeight02}px">
        <img src="${couponPage.bg02}" style="height:100%" />
        <div style="position: absolute;width: 100%;height: 100%;top: 0;align-items: center;justify-content: center; display: flex;">


            {{if status==1 }}
            <div style="width:100%;top:0px;text-align: center;font-size:24px;color:#f53300;">
                <p>${noStartDesc}</p>
            </div>
            {{else status==2}}
            <div style="width:50%;float:left;text-align: right;">
                <img class="btn-com operate btn-GoBuy" src="${couponPage.bg4GoBuy}" style="margin-right:25px;display: inline-block;cursor:pointer" />
            </div>
            <div style="width:50%;float:left;text-align:left;">
                <img class="btn-com operate btn-GoInvite " src="${couponPage.bg4GoInvite}" style="margin-left:25px;display: inline-block;cursor:pointer" />
            </div>
            {{else status==3}}
            <div style="width:100%;top:0px;text-align: center;font-size:24px;color:#f53300;">
                <p>${endDesc}</p>
            </div>
            {{/if}}
        </div>
    </div>
    <div style="position: relative;height:${couponPage.bgHeight03}px">
        <img src="${couponPage.bg03}" style="height:100%" />
        <a href="/Personal/Index">
            <img class="btn-com operate btn-GoPersonal" src="${couponPage.bg4GoPersonal}" style="margin-right:15px;display: inline-block; bottom: 12%;right: 5%;position: absolute;" />
        </a>
    </div>
</script>

<script id="config_payResultPage_tmpl" type="text/x-jquery-tmpl">
    <div style="height:${payResultPage.bgHeight01}px">
        <img src="${payResultPage.bg01}" style="height:100%"/>
    </div>
    <div style="position: relative;height:${payResultPage.bgHeight02}px">
        <img src="${payResultPage.bg02}" style="height:100%" />
        <div style="position: absolute;width: 100%;height: 100%;top: 0;align-items: center;justify-content: center; display: flex;">
            {{if status==1 }}
            <div style="width:100%;top:0px;text-align: center;font-size:24px;color:#f53300;">
                <p>${noStartDesc}</p>
            </div>
            {{else status==2}}
            <div style="width:50%;float:left;text-align: right;">
                <img class="btn-com operate btn-GetCoupon" src="${payResultPage.bg4GetCoupon}" style="margin-right:15px;display: none;cursor:pointer" />
                <img class="btn-com operate btn-OpenCoupon" src="${payResultPage.bg4OpenCoupon}" style="margin-right:15px;display: inline-block;cursor:pointer" />
            </div>
            <div style="width:50%;float:left;text-align:left;">
                <img class="btn-com operate btn-GoInvite" src="${payResultPage.bg4GoInvite}" style="margin-left:15px;display: inline-block;cursor:pointer" />
            </div>
            {{else status==3}}
            <div style="width:100%;top:0px;text-align: center;font-size:24px;color:#f53300;">
                <p>${endDesc}</p>
            </div>
            {{/if}}
        </div>
    </div>
    <div style="height:${payResultPage.bgHeight03}px">
        <img src="${payResultPage.bg03}" style="height:100%" />
    </div>
    <div style="position: relative;height:${payResultPage.bgHeight04}px">
        <img src="${payResultPage.bg04}" style="height:100%" />
        <div style="position: absolute;width: 100%;height: 100%;top: 0;align-items: center;justify-content: flex-end ;right: 5%;  display: flex;">

            <a href="/Personal/Index">
                <img class="btn-com operate btn-GoPersonal" src="${payResultPage.bg4GoPersonal}" style="cursor:pointer" />
            </a>

        </div>
    </div>
</script>

<div class="gbr gbr-main">
    <div id="config">
        <div id="config_couponPage" style="display:none"></div>
        <div id="config_payResultPage" style="display:none"></div>
    </div>
</div>

<div class="popd" id="popd4Info" style="display:none">
    <div class="popd-outer">
        <div class="popd-inter">
            <div id="popd4Info_btn_close" class="popd-close operate" style="position: absolute; right: -6px;top:-16px;"> <img src="~/Content/images/promote20180910/popd_close.png" style="width:32px;height:32px;" /></div>
            <div>
                <p style="color:#fb6088;text-align:center;font-size:18px;font-weight:bold; line-height:24px;margin-top:20px;">领取卡券</p>
                <p style="color:#fb6088;text-align:center;font-size:18px;font-weight:bold; line-height:24px;">请先填写以下信息</p>

                <div style="margin-top:20px;margin-bottom:20px;">

                    <ul class="list-input" style="overflow:hidden">
                        <li class="list-input-item">
                            <div class="item-left fl">
                                <div class="item-name  fl"><span>姓名</span></div>
                                <div class="item-value fr">
                                    <input id="txt_ctName" placeholder="请输入姓名" type="text" style="width:100%;" />
                                </div>
                            </div>
                        </li>
                        <li class="list-input-item">
                            <div class="item-left fl">
                                <div class="item-name fl"><span>手机号码</span></div>
                                <div class="item-value fr">
                                    <input id="txt_ctPhone" placeholder="请输入手机号码" type="text" style="width:100%;" />
                                </div>
                            </div>
                        </li>
                        <li class="list-input-item">
                            <div class="item-left fl">
                                <div class="item-name fl"><span>是否学员</span></div>
                                <div class="item-value fr">
                                    <span> <input id="rd_ctIsStudent_1" name="rd_ctIsStudent" class="radio" type="radio" value="1" checked /><label for="rd_ctIsStudent_1">是</label> </span>
                                    <span> <input id="rd_ctIsStudent_0" name="rd_ctIsStudent" class="radio" type="radio" value="0" /><label for="rd_ctIsStudent_0">否</label> </span>
                                </div>
                            </div>
                        </li>
                        <li class="list-input-item">
                            <div class="item-left fl">
                                <div class="item-name fl"><span>校区</span></div>
                                <div class="item-value fr">
                                    <input id="txt_ctSchool" value="" type="hidden" style="width:100%;" />
                                    <div id="sel_ctSchool">选择</div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                <div style="text-align:center;">
                    <img id="popd4Info_btn_sure" src="~/Content/images/promote20180910/btn_submit.png" class="btn-com operate" style="display: inline-block;" />
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script type="text/javascript">

        var pConfig;
        var couponPage = $('#config_couponPage');
        var payResultPage = $('#config_payResultPage');
        $(document).ready(function () {

            initConfig();

            $(".btn-GoBuy").live("click", function (e) {

                if ($.lumos.isUndefined(pConfig)) {
                    $.lumos.tips("信息配置加载未完成");
                    return;
                }

                if (pConfig.isGet) {
                    openCoupon();
                }
                else {
                    var _this = $(this);
                    $(_this).attr("disabled", "disabled");
                    $.lumos.postJson({
                        url: "/Promote/UnifiedOrder",
                        isShowLoading: true,
                        data: { type: "1", refereeId: pConfig.refereeId, orderPms: { promoteId: pConfig.promoteId, promoteCouponId: pConfig.promoteCouponId } },
                        success: function (d) {
                            if (d.result == $.lumos.resultType.success) {
                                var params = d.data;
                                pConfig.orderSn = params.orderSn;
                         
                                if (pConfig.isNeedBuy) {
                                    wx.chooseWXPay({
                                        appId: params.appId,
                                        timestamp: params.timestamp,
                                        nonceStr: params.nonceStr,
                                        package: params.package,
                                        signType: params.signType,
                                        paySign: params.paySign,
                                        success: function (res) {
                                            $.lumos.tips('您已支付成功');

                                            $(couponPage).hide();
                                            $(payResultPage).show();
                                            $('.btn-GetCoupon').css("display", "inline-block");
                                            $('.btn-OpenCoupon').hide();
                                        },
                                        cancel: function (res) {
                                            $.lumos.tips('您已取消支付');
                                        }
                                    });
                                }
                                else {
                                    getCoupon(function () {
                                        $(couponPage).hide();
                                        $(payResultPage).show();
                                    });
                                }
                            } else {
                                $.lumos.tips(d.message);
                                $(_this).removeAttr("disabled");
                            }
                        }
                    });
                }
            });

            $(".btn-OpenCoupon").live("click", function (e) {
                openCoupon();
            });

            $(".btn-GetCoupon").live("click", function (e) {

                getCoupon(function () {
                    $('.btn-GetCoupon').hide();
                    $('.btn-OpenCoupon').css("display", "inline-block");
                });

            });

            $('.btn-GoInvite').live("click", function (e) {

                var scrollTop = document.body.scrollTop;//网页被卷去的高
                $("#modal_Invite").css({ top: scrollTop + "px" });
                $("#modal_Invite").show();
                $("#share_container").show();

                $('#modal_Invite').bind("touchmove",
                    function (e) {
                        e.preventDefault();
                    });
                $("#modal_Invite").bind("mousewheel",
                    function (e) {
                        //阻止浏览器默认方法
                        e.preventDefault();
                    });
            });

            $("#modal_Invite").live("click", function (e) {
                $("#modal_Invite").hide();
            });

            $('#popd4Info_btn_sure').live("click", function (e) {

                if ($.lumos.isUndefined(pConfig)) {
                    $.lumos.tips("信息配置加载未完成");
                    return;
                }

                var ctName = $('#txt_ctName').val();
                var ctPhone = $('#txt_ctPhone').val();
                var ctIsStudent = $('input[name=rd_ctIsStudent]:checked').val();
                var ctSchool = $('#txt_ctSchool').val();

                if ($.lumos.isNullOrEmpty(ctName)) {
                    $.lumos.tips("请输入姓名");
                    return false;
                }

                if ($.lumos.isNullOrEmpty(ctPhone)) {
                    $.lumos.tips("请输入电话号码");
                    return false;
                }

                if ($.lumos.isNullOrEmpty(ctSchool)) {
                    $.lumos.tips("请选择校区");
                    return false;
                }

                $.lumos.postJson({
                    url: "/Promote/EditPromoteUserInfo",
                    isShowLoading: true,
                    data: { promoteId: pConfig.promoteId, ctName: ctName, ctPhone: ctPhone, ctIsStudent: ctIsStudent, ctSchool: ctSchool },
                    success: function (d) {
                        if (d.result == $.lumos.resultType.success) {
                            $('#popd4Info').hide();

                            if (pConfig.isNeedBuy) {
                                getCoupon(function () {
                                    $('.btn-GetCoupon').hide();
                                    $('.btn-OpenCoupon').css("display", "inline-block");
                                });
                            }
                            else {
                                getCoupon(function () {
                                    $(couponPage).hide();
                                    $(payResultPage).show();
                                });
                            }

                        }
                        else {
                            $.lumos.tips(d.message);
                        }
                    }
                });
            });

            $("#popd4Info_btn_close").live("click", function (e) {
                $("#popd4Info").hide();
            });

        });

        function initConfig() {
            var clientHeight = document.documentElement.clientHeight;
            $.lumos.getJson({
                url: "/Promotec/GetConfig?screenHeight=" + clientHeight,
                isShowLoading: true,
                success: function (d) {
                    if (d.result == $.lumos.resultType.success) {
                        pConfig = d.data;
                        initShareInfo();
                        document.title = pConfig.couponPage.title;//更改网页标题
                        $(couponPage).html($("#config_couponPage_tmpl").tmpl(pConfig));
                        $(payResultPage).html($("#config_payResultPage_tmpl").tmpl(pConfig));

                        if (pConfig.isNeedBuy) {
                            if (pConfig.isBuy) {
                                $(couponPage).hide();
                                $(payResultPage).show();

                                if (pConfig.isGet) {
                                    $('.btn-GetCoupon').hide();
                                    $('.btn-OpenCoupon').css("display", "inline-block");
                                }
                                else {
                                    $('.btn-GetCoupon').css("display", "inline-block");
                                    $('.btn-OpenCoupon').hide();
                                }
                            }
                            else {
                                $(couponPage).show();
                                $(payResultPage).hide();
                            }
                        }
                        else {
                            if (pConfig.isGet) {
                                $(couponPage).hide();
                                $(payResultPage).show();
                            }
                            else {
                                $(couponPage).show();
                                $(payResultPage).hide();
                            }
                        }


                        $('#txt_ctName').val(pConfig.userInfo.ctName);
                        $('#txt_ctPhone').val(pConfig.userInfo.ctPhone);
                        //$('input[name=rd_ctIsStudent]:checked')
                        //txt_ctSchool
                    }
                }
            });
        }

        function initShareInfo() {

            if ($.lumos.isUndefined(pConfig)) {
                $.lumos.tips("信息配置加载未完成");
                return;
            }

            var promoteId = pConfig.promoteId;
            var refereeId = pConfig.clientId;
            var shareTitle = pConfig.shareTitle;
            var shareDesc = pConfig.shareDesc;
            var shareLink = 'http://qyj.17fanju.com/Promotec/Coupon?promoteId=' + promoteId + '&refereeId=' + refereeId;
            var shareImgUrl = pConfig.shareImgUrl;
            wx.ready(function () {

                wx.onMenuShareAppMessage({
                    title: shareTitle,
                    desc: shareDesc,
                    link: shareLink,
                    imgUrl: shareImgUrl,
                    trigger: function (res) {
                    },
                    success: function (res) {
                        shareLog(promoteId, refereeId, shareLink, 1);
                    },
                    cancel: function (res) {
                    },
                    fail: function (res) {
                    }
                });

                wx.onMenuShareTimeline({
                    title: shareTitle,
                    link: shareLink,
                    imgUrl: shareImgUrl,
                    trigger: function (res) {
                    },
                    success: function (res) {
                        shareLog(promoteId, refereeId, shareLink, 2);
                    },
                    cancel: function (res) {
                    },
                    fail: function (res) {
                    }
                });

            });

        }

        function openCoupon() {

            if ($.lumos.isUndefined(pConfig)) {
                $.lumos.tips("信息配置加载未完成");
                return;
            }

            $.lumos.postJson({
                url: "/Promote/GetCardList",
                data: { promoteId: pConfig.promoteId },
                success: function (d) {
                    var cards = d.data;
                    var cardList = [];
                    for (var p in cards) {
                        cardList.push({ cardId: cards[p].cardId, code: cards[p].code });
                    }
                    wx.openCard({
                        cardList: cardList,
                        cancel: function (res) {

                        }
                    });
                }
            });
        }

        function getCoupon(suc) {

            if ($.lumos.isUndefined(pConfig)) {
                $.lumos.tips("信息配置加载未完成");
                return;
            }

            if ($.lumos.isNullOrEmpty(pConfig.orderSn)) {
                $.lumos.tips("订单未创建");
                return;
            }

            $.lumos.postJson({
                url: "/Promote/GetCardList",
                data: { promoteId: pConfig.promoteId },
                isShowLoading: true,
                success: function (d) {

                    if (d.result == $.lumos.resultType.success) {
                        var cards = d.data;
                        var cardList = [];
                        for (var p in cards) {
                            cardList.push({ cardId: cards[p].cardId, cardExt: cards[p].cardExt });
                        }
                        if (cardList.length > 0) {
                            wx.addCard({
                                cardList: cardList,
                                success: function (res) {

                                    if (typeof suc != "undefined") {
                                        suc();
                                    }
                                    pConfig.isGet = true;
                                    addCouponNotifyResult(res.cardList);
                                    //$.lumos.tips(JSON.stringify(res))
                                },
                                cancel: function (res) {
                                    //$.lumos.tips(JSON.stringify(res))
                                }
                            });
                        }
                    }
                    else {
                        if (d.code == "4001") {
                            $('#popd4Info').show();
                        }
                        else {
                            $.lumos.tips(d.messages);
                        }
                    }
                }
            });
        }

        function addCouponNotifyResult(cards) {

            var l_Data = [];
            l_Data.push({ name: "Model.PromoteId", value: pConfig.promoteId });
            $.each(cards, function (i, row) {
                l_Data.push({ name: "Model.Coupons[" + i + "].WxCouponId", value: row.cardId });
                l_Data.push({ name: "Model.Coupons[" + i + "].WxCouponEncryptCode", value: row.code });
            });

            $.lumos.postJson({
                url: "/Promote/AddCouponNotifyResult",
                data: l_Data,
                success: function (d) {
                    if (d.result == $.lumos.resultType.success) {
                        //window.location.href = "/Promotec/PayResult?promoteId=" + pConfig.promoteId + "&orderSn=" + pConfig.orderSn + "&isSuccessed=True";
                        $.lumos.tips('成功领取卡券');
                    }
                }
            });
        }

        var mobileSelect1 = new MobileSelect({
            trigger: '#sel_ctSchool',
            title: '选择校区',
            wheels: [
                        { data: schoolArr }
            ],
            position: [1], //初始化定位 打开时默认选中的哪个 如果不填默认为0
            transitionEnd: function (indexArr, data) {
                //console.log(data);
            },
            callback: function (indexArr, data) {
                $('#txt_ctSchool').val(data);
            }
        });
    </script>
}
